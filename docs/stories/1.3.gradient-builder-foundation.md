# Story 1.3: Gradient Builder Foundation

## Status
Done

## Story
**As a** designer or developer,
**I want** to generate linear and radial gradients with 2–5 color stops using perceptually uniform OKLCH interpolation,
**so that** I can create visually smooth gradients for UI backgrounds, illustrations, and branding.

## Acceptance Criteria
1. User can select between linear and radial gradient modes [Source: prd/4-functional-requirements.md#41-core-features]
2. User can add, remove, and reorder 2–5 color stops; each stop is a valid color (from palette or custom input) [Source: prd/4-functional-requirements.md#41-core-features]
3. Gradient preview updates live as stops or mode are changed [Source: prd/6-ux-overview-key-screens.md]
4. Color interpolation is performed in OKLCH space for perceptual smoothness [Source: architecture/6-color-engine-design.md#gradient-interpolation]
5. Linear gradients support angle selection (0–360°); radial gradients support center/ellipse toggle [Source: prd/6-ux-overview-key-screens.md]
6. All stops are clamped to sRGB; if out-of-gamut, chroma is reduced [Source: architecture/6-color-engine-design.md#gamut-handling]
7. API contract: expose `generateGradient(stops, kind, opts?)` returning a `Gradient` object with CSS/SVG string [Source: architecture/6-color-engine-design.md#key-apis; 5-type-models.md]
8. Tests: unit tests for interpolation, gamut clamping, and output string correctness [Source: architecture/13-testing-strategy.md]
9. State/UI integration: gradient state is managed in Zustand; preview is rendered in a `GradientPreview` component [Source: architecture/8-ui-component-architecture.md]

## Tasks / Subtasks
- [x] Task 1: Engine — implement OKLCH interpolation and gradient string generation (AC: 4,6,7)
  - [x] Add `src/engine/gradient.ts` with interpolation and gamut clamping helpers
  - [x] Implement `generateGradient(stops, kind, opts)` returning Gradient object with CSS/SVG string
- [x] Task 2: State — gradient slice (AC: 2,5,9)
  - [x] Add `src/state/useGradientSlice.ts` to manage stops, kind, angle, and options
  - [x] Integrate with palette for default stops; allow custom color input
- [x] Task 3: UI — GradientPreview and controls (AC: 1,2,3,5,9)
  - [x] Create `src/components/gradients/GradientPreview.tsx` to render live preview
  - [x] Add controls for mode (linear/radial), angle, stop management (add/remove/reorder), and color pickers
  - [x] Integrate with Zustand slice; disable preview if <2 stops
- [x] Task 4: Tests — unit + component (AC: 8)
  - [x] Add `src/tests/unit/engine/gradient.test.ts` for interpolation, gamut, and output string
  - [x] Add minimal component test for `GradientPreview` rendering

## Dev Notes

### Previous Story Insights
- Palette and color parsing logic are already implemented; leverage `toAllSpaces` and palette state for default stops.

### Data Models [Source: architecture/5-type-models.md]
- `Gradient` type: `{ kind: 'linear'|'radial', angle?: number, stops: Color[], css: string, svg: string }`

### API Specifications [Source: architecture/6-color-engine-design.md#key-apis]
```ts
export function generateGradient(stops: Color[], kind: 'linear'|'radial', opts?: {
  angle?: number
  center?: [number, number]
}): Gradient
```

### Algorithms [Source: architecture/6-color-engine-design.md#gradient-interpolation]
- Interpolate stops in OKLCH; clamp to sRGB after each step
- For linear: compute CSS `linear-gradient` string with angle
- For radial: compute CSS `radial-gradient` string; support ellipse/circle

### Gamut Handling [Source: architecture/6-color-engine-design.md#gamut-handling]
- Clamp each interpolated color to sRGB; reduce chroma if needed

### Component Specifications [Source: architecture/8-ui-component-architecture.md]
- `GradientPreview`: renders gradient swatch; controls for mode, angle, stops
- All state managed via Zustand; no prop drilling

### File Locations [Source: architecture/4-filefolder-structure-proposed.md]
- Engine: `src/engine/gradient.ts`
- State: `src/state/useGradientSlice.ts`
- UI: `src/components/gradients/GradientPreview.tsx`
- Tests: `src/tests/unit/engine/gradient.test.ts`

### Technical Constraints [Source: architecture/2-tech-stack-libraries.md]
- React 18 + Vite + TypeScript, Zustand for state, culori for color math, Vitest + React Testing Library

### Error Handling & Edge Cases [Source: architecture/12-error-handling-edge-cases.md]
- <2 stops disables preview; out-of-gamut colors are clamped

### Testing [Source: architecture/13-testing-strategy.md]
- Unit tests for interpolation, gamut, and output string
- Component tests for preview rendering and controls

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Scrum Master |
| 2025-10-04 | 1.1 | PO validation approved; status set to Approved | Product Owner |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
### QA Review Summary (2025-10-04)

#### Requirements Traceability
- All acceptance criteria are mapped to implemented code and tests:
  - Linear/radial mode, 2–5 stops, live preview, OKLCH interpolation, angle, and gamut handling are present.
  - API contract and state/UI integration are implemented as specified.

#### Test Coverage
- Unit tests: Interpolation, gamut clamping, and output string correctness are covered in `gradient.test.ts`.
- All tests pass; no blocking warnings.

#### Risk & NFR Assessment
- Functional risk: Low. Interpolation and gamut logic are robust; UI disables preview for <2 stops.
- Performance: Real-time preview is fast; no UI lag.
- Accessibility: Basic ARIA labels; full a11y deferred.
- Error handling: Out-of-gamut colors clamped; <2 stops disables preview.
- Maintainability: Modular code, clear types, isolated state.

#### Testability
- All logic is unit tested; UI is component tested. Zustand slices are mockable.

#### Technical Debt / Improvement Suggestions
- Consider e2e test for full user flow in a later epic.
- Expand a11y and keyboard navigation in future stories.

#### Gate Decision
- **PASS** — All acceptance criteria, NFRs, and testability requirements are met. No blocking issues.

#### Reviewer
- QA Agent (automated)