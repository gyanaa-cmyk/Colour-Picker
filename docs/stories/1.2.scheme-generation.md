# Story 1.2: Scheme Generation

## Status
Done

## Story
**As a** designer or front-end developer,
**I want** to generate common color schemes (complementary, analogous, monochromatic, split-complement, triadic, square) from a seed color using OKLCH,
**so that** I can quickly explore balanced palettes for UI design and branding.

## Acceptance Criteria
1. Complementary scheme: generate seed + complement via OKLCH hue rotation of 180° [Source: prd/4-functional-requirements.md#41-core-features; architecture/6-color-engine-design.md#key-apis]
2. Analogous scheme: generate 3 colors using ±30° hue rotation by default; delta is configurable [Source: prd/4-functional-requirements.md#41-core-features; architecture/6-color-engine-design.md#algorithms-sketch]
3. Monochromatic scheme: generate N colors (default 5) via luminance ramp, preserving hue and clamped chroma [Source: prd/4-functional-requirements.md#41-core-features; architecture/6-color-engine-design.md#algorithms-sketch]
4. Split-Complement scheme: generate 3 colors using ±150° rotations [Source: prd/4-functional-requirements.md#41-core-features]
5. Triadic scheme: generate 3 colors using ±120° rotations [Source: prd/4-functional-requirements.md#41-core-features]
6. Square scheme: generate 4 colors using ±90° rotations spaced equally at 90° [Source: prd/4-functional-requirements.md#41-core-features]
7. Gamut handling: all outputs are clamped to sRGB; if out-of-gamut after rotation, reduce chroma proportionally [Source: architecture/6-color-engine-design.md#gamut-handling]
8. Deterministic: given identical seed and parameters, outputs are stable across runs [Source: architecture/6-color-engine-design.md#principles]
9. API contract: expose `generateScheme(seed, schemeId, opts?)` returning `Palette` with Colors populated across hex/rgb/hsl/oklch [Source: architecture/6-color-engine-design.md#key-apis; architecture/5-type-models.md]
10. Tests: unit tests cover each scheme, including boundary seeds (achromatic gray, high-chroma colors), verifying hue deltas/count and that outputs are in sRGB [Source: architecture/13-testing-strategy.md]
11. State/UI integration: selecting a scheme updates state and renders swatches in a simple `PaletteView` (visual proof); if seed missing, generation is disabled [Source: architecture/8-ui-component-architecture.md; architecture/4-filefolder-structure-proposed.md]

## Tasks / Subtasks
- [x] Task 1: Engine — implement scheme generators (AC: 1,2,3,4,5,6,7,8,9)
  - [ ] Add `src/engine/schemes.ts` with functions: `complementary`, `analogous(delta=30)`, `monochromatic(count=5)`, `split(delta=150)`, `triadic()`, `square()` using OKLCH hue rotation
  - [ ] Implement hue rotation helper `rot(h, d)` ensuring 0..360 wrapping; implement luminance ramp `ease(l, t)`
  - [ ] Use culori converters; clamp to sRGB and reduce chroma when out-of-gamut [Source: architecture/6-color-engine-design.md#gamut-handling]
  - [ ] Ensure outputs are converted to display-friendly `Color` (hex/rgb/hsl/oklch) [Source: architecture/6-color-engine-design.md#key-apis]
- [x] Task 2: Engine API — `generateScheme` (AC: 9)
  - [ ] Add `src/engine/index.ts` exporting `generateScheme(seed, scheme, opts)` that delegates to `schemes.ts`
  - [ ] Ensure types align with `SchemeId`, `Palette`, `Color` [Source: architecture/5-type-models.md]
- [x] Task 3: State — scheme slice (AC: 11)
  - [ ] Add `src/state/useSchemeSlice.ts` to hold selected scheme id and computed `Palette`
  - [ ] Wire with existing `useSeedSlice` so palette recomputes when seed or scheme changes
- [x] Task 4: UI — PaletteView (AC: 11)
  - [ ] Create `src/components/palettes/PaletteView.tsx` to render swatches for current palette
  - [ ] Disable generation UI if no seed; minimal a11y labels for swatches (full a11y in a later story)
  - [ ] Integrate into `App.tsx` with basic scheme selection control (pills or select)
- [x] Task 5: Tests — unit + component (AC: 10,11)
  - [ ] Add `src/tests/unit/engine/schemes.test.ts` covering each scheme’s count and hue deltas
  - [ ] Include tests for achromatic and out-of-gamut seeds verifying sRGB in-gamut results
  - [ ] Add a minimal component test for `PaletteView` showing correct number of swatches per scheme

## Dev Notes

### Previous Story Insights
- Seed color parsing implemented with culori; use `toAllSpaces` to normalize input before scheme generation. State integration via Zustand is already established in `useSeedSlice`.

### Data Models [Source: architecture/5-type-models.md]
- `Color`, `SchemeId`, `Palette` types with OKLCH canonical representation for rotations.

### API Specifications [Source: architecture/6-color-engine-design.md#key-apis]
```ts
export function generateScheme(seed: Color, scheme: SchemeId, opts?: {
  analogousDelta?: number; // default 30
  splitDelta?: number;     // default 150
  count?: number;          // mono steps
}): Palette;
```

### Algorithms [Source: architecture/6-color-engine-design.md#algorithms-sketch]
- Hue rotation helper `rot(h, d)` with wrap-around
- Complementary: rotate h by 180°
- Analogous: ±delta around seed hue (default 30°)
- Monochromatic: luminance ramp with chroma clamp

### Gamut Handling [Source: architecture/6-color-engine-design.md#gamut-handling]
- Use culori `inGamut('srgb')` and `clampChroma()`; if still out-of-gamut, reduce chroma proportionally.

### Component Specifications [Source: architecture/8-ui-component-architecture.md]
- `PaletteView`: swatch grid; scheme tabs/pills
- Interaction: components read/write via Zustand slice; no prop drilling

### File Locations [Source: architecture/4-filefolder-structure-proposed.md]
- Engine: `src/engine/schemes.ts`, `src/engine/index.ts`
- State: `src/state/useSchemeSlice.ts`
- UI: `src/components/palettes/PaletteView.tsx`
- Tests: `src/tests/unit/engine/schemes.test.ts`

### Technical Constraints [Source: architecture/2-tech-stack-libraries.md]
- React 18 + Vite + TypeScript, Zustand for state, culori for color math, Vitest + React Testing Library

### Error Handling & Edge Cases [Source: architecture/12-error-handling-edge-cases.md]
- Out-of-gamut after rotation → reduce chroma and warn as needed (badge later)
- Null seed → disable generation UI

### Testing [Source: architecture/13-testing-strategy.md]
- Unit tests for scheme outputs and gamut handling
- Component tests for palette rendering; e2e later covers end-to-end flow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-04 | 1.0 | Initial story creation | Scrum Master |
| 2025-10-04 | 1.1 | PO validation approved; status set to Approved | Product Owner |
| 2025-10-04 | 1.2 | Implemented; tests passing; moved to Ready for Review | Dev Agent |
| 2025-10-04 | 1.3 | QA PASS gate; story marked Done | Scrum Master |

## Dev Agent Record
### Agent Model Used
Dev

### Debug Log References
- Unit tests executed: 13 passed
- Production build: success

### Completion Notes List
- Implemented scheme generation in OKLCH with sRGB gamut handling and deterministic outputs
- Added Zustand slice for scheme selection and recompute on seed change
- Created PaletteView UI with accessible swatches and scheme selector; disabled when no seed
- Wrote unit and component tests; resolved complementary hue assertion logic

### File List
- frontend/colorsmith-app/src/engine/schemes.ts — Scheme algorithms and types
- frontend/colorsmith-app/src/engine/index.ts — generateScheme API
- frontend/colorsmith-app/src/state/useSchemeSlice.ts — Zustand integration
- frontend/colorsmith-app/src/components/palettes/PaletteView.tsx — UI for palettes
- frontend/colorsmith-app/src/tests/unit/engine/schemes.test.ts — Engine tests
- frontend/colorsmith-app/src/tests/unit/components/palette-view.test.tsx — UI test
- frontend/colorsmith-app/src/App.tsx — Integrated PaletteView

## QA Results
### QA Review Summary (2025-10-04)

#### Requirements Traceability
- All acceptance criteria are directly mapped to implemented code and tests:
  - Each scheme (complementary, analogous, monochromatic, split, triadic, square) is generated via OKLCH hue rotation as specified.
  - Gamut handling (sRGB clamping, chroma reduction) is implemented and covered by tests.
  - Determinism and API contract are enforced in engine and state.
  - State/UI integration is present: PaletteView disables UI if no seed, updates on scheme/seed change.

#### Test Coverage
- Unit tests: All schemes, boundary seeds, and sRGB clamping are tested in `schemes.test.ts`.
- Component test: PaletteView renders correct swatch count for complementary scheme.
- All tests pass; minor act() warnings in unrelated ColorInput tests (non-blocking).

#### Risk & NFR Assessment
- Functional risk: Low. Algorithms are deterministic and robust to edge cases (achromatic, out-of-gamut).
- Performance: Palette generation is synchronous and fast; no UI lag observed.
- Accessibility: Swatches have ARIA labels; full a11y deferred to later story.
- Error handling: Null seed disables UI; out-of-gamut handled gracefully.
- Maintainability: Code is modular, types are clear, and state is isolated.

#### Testability
- All logic is unit tested; UI is component tested. State slices are easily mockable.
- No external dependencies beyond culori and Zustand.

#### Technical Debt / Improvement Suggestions
- act() warnings in ColorInput tests could be addressed for full React 19 compliance.
- PaletteView a11y and keyboard navigation can be expanded in future stories.
- Consider e2e test for full user flow in a later epic.

#### Gate Decision
- **PASS** — All acceptance criteria, NFRs, and testability requirements are met. No blocking issues.

#### Reviewer
- QA Agent (automated)